<!DOCTYPE html>
<html>
<!--
https://www.pg-versus-ms.com/
-->

   <meta charset="UTF-8">
   <title>PostgreSQL</title>
<!-- mapview_v1 {{{ -->
<script>
var zoomDivDOM
function doCloseZoom() {
  zoomDivDOM.innerHTML = ''; 
  zoomDivDOM.style.display="none";
}
var zoomDivFW = true; // FW Full Width
var zoomDivFH = true; // FW Full Height 
var zoomDivTop = true; 
var zoomDivLft = true; 

var zoom=0.1
var idxXXXsmallRule=-1;
var idxXXsmallRule =-1;
var idxXsmallRule  =-1;
function onZoomOut(){
  zoom=zoom - 0.05
  document.styleSheets[0]['cssRules'][idxXXXsmallRule].style['font-size']=zoom+'rem';
}
function onZoomIn(){
  zoom=zoom + 0.05
  document.styleSheets[0]['cssRules'][idxXXXsmallRule].style['font-size']=zoom+'rem';
}
function doOpenZoom(e)      { 
  zoomDivDOM.innerHTML = 
     "<span style='font-size:1.0rem; color:blue;'>('Esc' to close)<br/></span>" 
   + this.outerHTML; 
  zoomDivDOM.style.display="block";
  e.stopPropagation();
}

function removeToLeftMarginInPre() {
  // TODO:(0) Not working
  // nodeList = document.querySelectorAll('pre')
  // for (idx in nodeList) { 
  //   var node = nodeList[idx]
  //   var html = node.innerHTML
  //   var pattern = html.match(/^\s*[|]/)
  //   var regEx = new RegExp(pattern, "")
  //   console.log(html)
  //   node.innerHTML = html.replace(regEx,''))
  //    
  // }
}


function onPageLoaded() {
  zoomDivDOM = document.getElementById('zoomDiv')
  document.addEventListener('keyup',function(e) { if (e.code !== "Escape") return; doCloseZoom(); })
  // Change default a.target to blank. Ussually this is bad practice 
  // but this is the exception to the rule
  var nodeList = document.querySelectorAll('a')
  for (idx in nodeList) { 
      if (!nodeList[idx].href) { continue; }
      if (nodeList[idx].href && !nodeList[idx].href.startsWith("http")) continue;
      nodeList[idx].target='_blank'; 
  }
  nodeList = document.querySelectorAll('td')
  for (idx in nodeList) { 
     if (!!! nodeList[idx].addEventListener) continue;
     nodeList[idx].addEventListener('dblclick',doOpenZoom, false)
  }
  nodeList = document.querySelectorAll('*[zoom]')
  for (idx in nodeList) { 
     if (!!! nodeList[idx].addEventListener) continue;
     nodeList[idx].addEventListener('dblclick',doOpenZoom, false)
  }

  removeToLeftMarginInPre();

  for (idx=0; idx<document.styleSheets[0]['cssRules'].length; idx++){
      if( document.styleSheets[0]['cssRules'][idx].selectorText == "[xxxsmall]") {
          idxXXXsmallRule=idx;
      }
      if( document.styleSheets[0]['cssRules'][idx].selectorText == "[xxsmall]") {
          idxXXsmallRule=idx;
      }
      if( document.styleSheets[0]['cssRules'][idx].selectorText == "[xsmall]"  ) {
          idxXsmallRule=idx;
      }
  }
  // Simulate initial dblclick to show help
  var event = new MouseEvent('dblclick', { 'view': window, 'bubbles': true, 'cancelable': true });
  document.getElementById('initialMessage').dispatchEvent(event);
}
</script>
<style { >
*[blue]         { color:blue !important;  }
*[orange]         { color:orange !important; }
*[green]         { color:green !important;  }
*[brown]         { color:brown !important;  }
b { color: #0A9}
*[mono]         { font-family: monospace; white-space: pre; }
pre { background-color:#EEEEEE; outline:1px dotted grey; margin: 0; }
*[cite]         { font-style: italic; }
*[TODO]         { color:red; font-weight: bold; }
*[TODO]:before  { content: "TODO:"; }
*[xxxsmall]{ font-size:0.1rem; }
img[xxxsmall]{ max-width:10rem; }
*[xxsmall] { font-size:0.3rem; }
*[xsmall]  { font-size:0.7rem; }
*[small]   { font-size:0.9rem; }
*[xxbig]  { font-size:1.7em; font-weight: bold; color:#007733;}
*[xbig]  { font-size:1.5em; }
*[hidden]  { display:none; }
ul,ol { margin-left: 1.0em; padding-left: 0rem; }
#zoomDiv [xxxsmall] , #zoomDiv * [xxxsmall], #zoomDiv * * [xxxsmall], #zoomDiv * * * [xxxsmall]{ font-size:1em; } 
#zoomDiv img[xxxsmall] , #zoomDiv * img[xxxsmall], #zoomDiv * * img[xxxsmall], #zoomDiv * * * img[xxxsmall]{ max-width:100%; } 

/* REF: https://stackoverflow.com/questions/4910077/select-all-child-elements-recursively-in-css */
#zoomDiv * [small], #zoomDiv * [xsmall], #zoomDiv * [xxsmall] { font-size:1em; }
#zoomDiv *[small], #zoomDiv *[xsmall], #zoomDiv *[xxsmall] { font-size:1em; }
#zoomDiv * td { font-size:1em; }

body      { font-family:sans-serif; font-size:16px; padding: 0; margin: 0; }
#zoomDiv  { 
   display:none;
   position:fixed; top:0.1%; left:0.1%; width:auto; height:auto;
   max-height: 98%; max-width: 98%; overflow: auto;
   background-color:#FFFFFF; color:#000; border-radius: 0.5rem; border: 4px solid black; font-size: 2rem;
   box-shadow: 5px 5px 30px black;
   padding: 0.5rem;
}

a            { text-decoration:none; font-family:monospace; padding:0.0;}
a[href^="#"]:before /* mark internal anchor */ {  content: ">"; }
a[href^="#"]:after  /* mark internal anchor */ {  content: "<"; }
a:visited { color:blue; }
td { 
   font-size: 0.8rem;
   vertical-align: top;
   outline: 1px solid grey; 
}
td,th               {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col0] ,th[col1]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col2] ,th[col2]  {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col3] ,th[col3]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col4] ,th[col4]  {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col5] ,th[col5]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col6] ,th[col6]  {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col7] ,th[col7]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col8] ,th[col8]  {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col9] ,th[col9]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col10],th[col10] {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col11],th[col11] {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col12],th[col12] {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
tr[header_delimit] > *{background-color:#000000; color:#FFFFFF; font-size:2em; color: white; }
tr[header_delimit] > td > a{color:inherit; text-decoration: underline; }
div[subtable1] { max-width: 95%; overflow: auto; padding:0; margin: 0;}

table { width:100% border:0; margin: 0;}
</style }>
</head>
<body onLoad='onPageLoaded()'>
<b id='initialMessage' orange>Hint double-click on elements to zoom!!</b>
<div id='zoomDiv'></div>
<div style="position:fixed; right:0.3%; bottom:0; width:auto;">
<b style="font-size:1.5rem" orange><a onclick="onZoomOut()">[-A]</a></b>
<b style="font-size:1.5rem"       >                                 </b>
<b style="font-size:2.0rem" orange><a onclick="onZoomIn ()">[A+]</a></b>
</div>
<!-- mapview_v1 }}} -->

<table { >
<tr {>
  <td> </td> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
</tr }>
<tr {>
  <td col1 colspan=6 >
<pre { >
ENV.VARS:
PGPORT
PGUSER  (alt. -U option)


1 Server 1<--> N Databases 


Create new Database Cluster:
OS admin -> shell:<b># initdb -D /usr/local/pgsql/data</b>
                  alternatively
                  <b># pg_ctl -D /usr/local/pgsql/data initdb</b>
                  ('postgres' and 'template1' ddbbs will be created inside)

                   init ddbb storage area (data directory in file-system terms) 
                 This is the database/catalog cluster:
                 Collection of DDBB managed by a single instance

                 
the default client authentication setup allows any local user
to connect to the database and even become the database superuser.
 If you do not trust them:
  - use one initdb -W, --pwprompt or --pwfile options 
    to assign a password to the database superuser.
  - also, specify -A md5 or -A password so that the 
    default trust authentication mode is not used; 
    or modify the generated <b>pg_hba.conf</b> file after running initdb
    , but before you start the server for the first time.

Starting the SErver
OS admin -> shell: <b># su postgres -c 'postgres -D /usr/local/pgsql/data 1>/var/log/postgresql/logfile 2>&1 &'</b>
                   alternatively (using pg_ctl "easy" wrapper)
                   <b># su postgres -c 'postgres@~$ pg_ctrl start -l /var/log/postgresql/logfile'

Create new DDBB:
"admin" -> PostgreSQL: create user account
("admin" ussually match postgres OS user)
...
user -> shell: $ createdb mydb

Many tools assume ddbb names == (-U,PGUSER) username by default
Drop existing DDBB:
user -> shell: $ dropdb mydb # warn can NOT be undon

Console access:
user -> shell: $ psql mydb
</pre }>
  <td col1 colspan=6 >
<pre { >
mydb=> SELECT version();
mydb=> SLECT current_date;
psql commands:
\?
\h
\q
\dt

</pre }>
  </td>  
</tr }>
</table } >
</body>
<!--
COPY weather FROM '/home/user/weather.txt';


-- DO $$
-- BEGIN
--   EXECUTE 'ALTER DATABASE ' || current_database() || ' SET TIMEZONE TO UTC';
-- END; $$;

CREATE TABLE devices (
  ID         VARCHAR(40)                NOT NULL CONSTRAINT DEVICE_PK PRIMARY KEY,
  NAME       VARCHAR(255)               NOT NULL,
  CREATED_AT TIMESTAMP    DEFAULT NOW() NOT NULL,
  UPDATED_AT TIMESTAMP    DEFAULT NOW() NOT NULL,
  OWNER_ID   VARCHAR(40)                NOT NULL,
-- PUB_KEY NOT YET USED. Can be used to cipher message and decipher using device private key
  PUB_KEY    VARCHAR(88)                NOT NULL UNIQUE
);
CREATE INDEX DEVICE_PUB_KEY_IDX ON devices   (PUB_KEY);

CREATE TABLE coupons (
  ID         VARCHAR(40)                NOT NULL CONSTRAINT COUPON_PK PRIMARY KEY,
  TYPE       VARCHAR(10)                NOT NULL,
  STATUS     VARCHAR(10)                NOT NULL,
  CREATED_AT TIMESTAMP    DEFAULT NOW() NOT NULL,
  UPDATED_AT TIMESTAMP    DEFAULT NOW() NOT NULL,
  AMOUNT     INTEGER      DEFAULT     1 NOT NULL,
  TARGET     VARCHAR(88)                NOT NULL,
-- TODO:(0) Remove Null in Database!!!
  DEVICE_ID  VARCHAR(40)                NULL CONSTRAINT COUPON_FK3 REFERENCES devices (ID),
  COUPON     VARCHAR(255)               NOT NULL
); 
CREATE INDEX COUPON_TYPE_IDX    ON coupons     (TYPE);
CREATE INDEX COUPON_TARGET_IDX  ON coupons   (TARGET);
-->

<--
pg_upgrade
-->

<--
http://www.time-travellers.org/shane/papers/NFS_considered_harmful.html
...  this can cause reliability problems (see http://www.time-travellers.org/shane/papers/NFS_considered_harmful.html). Specifically, delayed (asynchronous) writes to the NFS server can cause data corruption problems. If possible, mount the NFS file system synchronously (without caching) to avoid this hazard. Also, soft-mounting the NFS file system is not recommended.
-->

<!--
Tunning OS resources (Shared Memory/Semaphores/...):
https://www.postgresql.org/docs/10/static/kernel-resources.html


Upgrading the server: (pg_dumpall, pg_upgrade, replication)
https://www.postgresql.org/docs/10/static/upgrading.html
https://www.postgresql.org/docs/10/static/encryption-options.html

____________________________
Encryption Options
https://www.postgresql.org/docs/10/static/encryption-options.html
 The pg_hba.conf file allows administrators to specify which hosts can use non-encrypted connections (host) and which require SSL-encrypted connections (hostssl). Also, clients can specify that they connect to servers only via SSL.


The pgcrypto module allows certain fields to be stored encrypted. This is useful if only some of the data is sensitive. The client supplies the decryption key and the data is decrypted on the server and then sent to the client.

  It is possible for both the client and server to provide SSL certificates to each other. 
Secure TCP/IP connections with SSSecure TCP/IP connections with SSLL
https://www.postgresql.org/docs/10/static/ssl-tcp.html
_____________

Server instance configuration:
(/usr/local/pgsql/data/...)postgresql.conf
(Re-read with SIGHUP signal, alt. $ pg_ctl reload)

<a href='https://www.postgresql.org/docs/10/static/view-pg-file-settings.html'>pg_file_settings</a> can be used to debug or pre-test changes in conf.

@ma: https://www.postgresql.org/docs/10/static/config-setting.html
_________________
Developing an Intelligent Analytics App with PostgreSQL
https://www.infoq.com/vendorcontent/show.action?vcr=4727

-->
</html>
