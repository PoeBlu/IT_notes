!DOCTYPE html>
<html>
   <meta charset="UTF-8">
   <title>OpenSSL Certificate Handling Map</title>
<!-- mapview_v1 {{{ -->
<script>
var zoomDivDOM
function doCloseZoom() {
  zoomDivDOM.innerHTML = ''; 
  zoomDivDOM.style.display="none";
}
var zoomDivFW = true; // FW Full Width
var zoomDivFH = true; // FW Full Height 
var zoomDivTop = true; 
var zoomDivLft = true; 

var zoom=0.1
var idxXXXsmallRule=-1;
var idxXXsmallRule =-1;
var idxXsmallRule  =-1;
function onZoomOut(){
  zoom=zoom - 0.05
  document.styleSheets[0]['cssRules'][idxXXXsmallRule].style['font-size']=zoom+'rem';
}
function onZoomIn(){
  zoom=zoom + 0.05
  document.styleSheets[0]['cssRules'][idxXXXsmallRule].style['font-size']=zoom+'rem';
}
function doOpenZoom(e)      { 
  zoomDivDOM.innerHTML = 
     "<span style='font-size:1.0rem; color:blue;'>('Esc' to close)<br/></span>" 
   + this.outerHTML; 
  zoomDivDOM.style.display="block";
  e.stopPropagation();
}

function removeToLeftMarginInPre() {
  // TODO:(0) Not working
  // nodeList = document.querySelectorAll('pre')
  // for (idx in nodeList) { 
  //   var node = nodeList[idx]
  //   var html = node.innerHTML
  //   var pattern = html.match(/^\s*[|]/)
  //   var regEx = new RegExp(pattern, "")
  //   console.log(html)
  //   node.innerHTML = html.replace(regEx,''))
  //    
  // }
}


function onPageLoaded() {
  zoomDivDOM = document.getElementById('zoomDiv')
  document.addEventListener('keyup',function(e) { if (e.code !== "Escape") return; doCloseZoom(); })
  // Change default a.target to blank. Ussually this is bad practice 
  // but this is the exception to the rule
  var nodeList = document.querySelectorAll('a')
  for (idx in nodeList) { 
      if (!nodeList[idx].href) { continue; }
      if (nodeList[idx].href && !nodeList[idx].href.startsWith("http")) continue;
      nodeList[idx].target='_blank'; 
  }
  nodeList = document.querySelectorAll('td')
  for (idx in nodeList) { 
     if (!!! nodeList[idx].addEventListener) continue;
     nodeList[idx].addEventListener('dblclick',doOpenZoom, false)
  }
  nodeList = document.querySelectorAll('*[zoom]')
  for (idx in nodeList) { 
     if (!!! nodeList[idx].addEventListener) continue;
     nodeList[idx].addEventListener('dblclick',doOpenZoom, false)
  }

  removeToLeftMarginInPre();

  for (idx=0; idx<document.styleSheets[0]['cssRules'].length; idx++){
      if( document.styleSheets[0]['cssRules'][idx].selectorText == "[xxxsmall]") {
          idxXXXsmallRule=idx;
      }
      if( document.styleSheets[0]['cssRules'][idx].selectorText == "[xxsmall]") {
          idxXXsmallRule=idx;
      }
      if( document.styleSheets[0]['cssRules'][idx].selectorText == "[xsmall]"  ) {
          idxXsmallRule=idx;
      }
  }
  // Simulate initial dblclick to show help
  var event = new MouseEvent('dblclick', { 'view': window, 'bubbles': true, 'cancelable': true });
  document.getElementById('initialMessage').dispatchEvent(event);
}
</script>
<style { >
*[blue]         { color:blue !important;  }
*[orange]         { color:orange !important; }
*[green]         { color:green !important;  }
*[brown]         { color:brown !important;  }
b { color: #0A9}
*[mono]         { font-family: monospace; white-space: pre; }
pre { background-color:#EEEEEE; outline:1px dotted grey; margin: 0; }
*[cite]         { font-style: italic; }
*[TODO]         { color:red; font-weight: bold; }
*[TODO]:before  { content: "TODO:"; }
*[xxxsmall]{ font-size:0.1rem; }
img[xxxsmall]{ max-width:10rem; }
*[xxsmall] { font-size:0.3rem; }
*[xsmall]  { font-size:0.7rem; }
*[small]   { font-size:0.9rem; }
*[xxbig]  { font-size:1.7em; font-weight: bold; color:#007733;}
*[xbig]  { font-size:1.5em; }
*[hidden]  { display:none; }
ul,ol { margin-left: 1.0em; padding-left: 0rem; }
#zoomDiv [xxxsmall] , #zoomDiv * [xxxsmall], #zoomDiv * * [xxxsmall], #zoomDiv * * * [xxxsmall]{ font-size:1em; } 
#zoomDiv img[xxxsmall] , #zoomDiv * img[xxxsmall], #zoomDiv * * img[xxxsmall], #zoomDiv * * * img[xxxsmall]{ max-width:100%; } 

/* REF: https://stackoverflow.com/questions/4910077/select-all-child-elements-recursively-in-css */
#zoomDiv * [small], #zoomDiv * [xsmall], #zoomDiv * [xxsmall] { font-size:1em; }
#zoomDiv *[small], #zoomDiv *[xsmall], #zoomDiv *[xxsmall] { font-size:1em; }
#zoomDiv * td { font-size:1em; }

body      { font-family:sans-serif; font-size:16px; padding: 0; margin: 0; }
#zoomDiv  { 
   display:none;
   position:fixed; top:0.1%; left:0.1%; width:auto; height:auto;
   max-height: 98%; max-width: 98%; overflow: auto;
   background-color:#FFFFFF; color:#000; border-radius: 0.5rem; border: 4px solid black; font-size: 2rem;
   box-shadow: 5px 5px 30px black;
   padding: 0.5rem;
}

a            { text-decoration:none; font-family:monospace; padding:0.0;}
a[href^="#"]:before /* mark internal anchor */ {  content: ">"; }
a[href^="#"]:after  /* mark internal anchor */ {  content: "<"; }
a:visited { color:blue; }
td { 
   font-size: 0.8rem;
   vertical-align: top;
   outline: 1px solid grey; 
}
td,th               {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col0] ,th[col1]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col2] ,th[col2]  {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col3] ,th[col3]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col4] ,th[col4]  {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col5] ,th[col5]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col6] ,th[col6]  {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col7] ,th[col7]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col8] ,th[col8]  {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col9] ,th[col9]  {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col10],th[col10] {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
td[col11],th[col11] {background-color:#FFFFFF; min-width:8.25%; max-width:8.25%; }
td[col12],th[col12] {background-color:#FAFAFA; min-width:8.25%; max-width:8.25%; }
tr[header_delimit] > *{background-color:#000000; color:#FFFFFF; font-size:2em; color: white; }
tr[header_delimit] > td > a{color:inherit; text-decoration: underline; }
div[subtable1] { max-width: 95%; overflow: auto; padding:0; margin: 0;}

table { width:100% border:0; margin: 0;}
</style }>
</head>
<body onLoad='onPageLoaded()'>
<b id='initialMessage' orange>Hint double-click on elements to zoom!!</b>
<div id='zoomDiv'></div>
<div style="position:fixed; right:0.3%; bottom:0; width:auto;">
<b style="font-size:1.5rem" orange><a onclick="onZoomOut()">[-A]</a></b>
<b style="font-size:1.5rem"       >                                 </b>
<b style="font-size:2.0rem" orange><a onclick="onZoomIn ()">[A+]</a></b>
</div>
<!-- mapview_v1 }}} -->
<table style='width:100%'{>
<tbody>
<tr {>
  <th colspan=3 header_delimit {   >topic1</th>
</tr }>
<tr {>
  <td col1 >
<pre>
Flow:
admin->admin: Create Private Key
admin->admin: Create CSR
alt
  admin->admin: Create self-certificate
else:
  admin->CA   : CSR
  CA->CA      : Create certificate
  CA->amdin   : certificate
</pre>
<br/>
<pre>
Certificate Signing Request<span xxbig>(CSR)</span>:=
    PUBLIC KEY  
  + Distinguised Name (DN) :=
       + Common Name (CN)
         (SHOULD be the exact 
          Fully Qualified Domain Name (FQDN) 
          of the host)
       + "additional info
          about organization"
</pre>
<br/>
    <ol>
      <li>Reutilize SUBJECT with ENV.VAR:
<pre small { >
$ export DOMAIN="mydomain.com"
$ export SUBJ=""
$ export SUBJ="${SUBJ}/C=ES"
$ export SUBJ="${SUBJ}/ST=Aragon"
$ export SUBJ="${SUBJ}/L=Zaragoza"
$ export SUBJ="${SUBJ}/O=MyOrganization"
$ export SUBJ="${SUBJ}/CN=${DOMAIN}"
</pre }>
      </li>
      <li>Create CSR (<code>-new</code>)<br/>
<pre { >
$ openssl req \
   -new \
   -nodes 
   -newkey rsa:2048 \
   -keyout ${DOMAIN}.key \
   -out ${DOMAIN}.csr -subj "${SUBJ}"
</pre }>
      (replace <code>-newkey rsa:.... -keyout...</code> by
       <code>-key ${DOMAIN}.key</code>) to use already existing private key)
       )
      </li>
    </ol>
  </td>  

  <td col2 >
    <span xxbig>Create autogenerated Self-Signed-Certificate (<code>-x509</code>):</span><br/>
    <span xbig><code>-nodes</code>: *DO NOT* pass-phrase-encrypt Pub.Key</span>
    <ul>
      <li>
        From new priv.key:
<pre { >
$ openssl req \
    -nodes \
    -newkey rsa:2048 -keyout ${DOMAIN}.key \
    -x509 \    # <- self signed
    -days ${DAYS_TO_EXPIRE} \
    -out ${DOMAIN}.crt -subj "${SUBJ}"
</pre }>
     Note 1: replace <code>-newkey rsa:.... -keyout...</code> by
       <code>-key ${DOMAIN}.key</code>) to use already existing private key)<br/>
     Note 2: replace <code>-new</code> by
       <code>-in ${DOMAIN.csr}</code>) to use already existing CSR<br/>
      </li>
    </ul>
    <span xbig>Managing Private Keys</span>
     <ul>
       <li>CREATE A PRIVATE KEY:
<pre {>
$ openssl \
    genrsa -des3 \
    -out ${DOMAIN}.key 2048
(Enter password when prompted)
</pre }>
       </li>
       <li>Verify (-check) Private Key:
<pre {>
$ openssl rsa -check -in ${DOMAIN}.key
</pre }>
       </li>
       <li>Verify private key matches certificate and CSR:<br/>
        (If the output of each of the next command is identical there is an
         extremely high probability that the private key, certificate, and CSR are related)
<pre xxsmall {>
$ openssl rsa  -noout -modulus -in ${DOMAIN}.key | openssl md5
$ openssl x509 -noout -modulus -in ${DOMAIN}.crt | openssl md5
$ openssl req  -noout -modulus -in ${DOMAIN}.csr | openssl md5
</pre }>
       </li>
       <li>Encrypt/Decrypt private key
<pre xxsmall {>
$ openssl rsa -des3 -in unencrypted.key -out encrypted.key
$ openssl rsa       -in encrypted.key   -out decrypted.key
</pre }>
       </li>
     </ul>
  </td>  
  <td col3 >
    <span xxbig>CONVERTING certs FORMATS (Defaults to PEM):</span><br/>
    (PKCS7 files, also known as P7B, are typically used in Java Keystores and Microsoft IIS (Windows).
   They are ASCII files which can contain certificates and CA certificates.)<br/>
    (PKCS12 ( also known as PFX files) are typically used for import/export certs-chains in Micrsoft IIS)<br/>
<pre xxsmall{>
# PEM   -> DER
$ openssl x509 -in ${DOMAIN}.crt -outform der -out ${DOMAIN}.der
# DER   -> PEM
$ openssl x509 -inform der -in ${DOMAIN}.der -out ${DOMAIN}.crt
# PEM   -> PKCS7
$ openssl crl2pkcs7 -nocrl -certfile ${DOMAIN}.crt
   -certfile ca-chain.crt -out ${DOMAIN}.p7b
# PKCS7 -> PEM
$ openssl pkcs7 -in ${DOMAIN}.p7b -print_certs -out ${DOMAIN}.crt
# PEM -> PKCS12
$ openssl pkcs12 -inkey ${DOMAIN}.key \
   -in ${DOMAIN}.crt -export -out ${DOMAIN}.pfx
# PKCS12 -> PEM 
$ openssl pkcs12 -in ${DOMAIN}.pfx -nodes -out ${DOMAIN}.combined.crt
</pre }>
  </td>  
</tr }>

<tr {>
  <td col1 >
    get openssl version and build(compilation) options:
<pre>$ openssl version -a</pre>
<br/>
    Download (first in chain) certificate from webpage and add to Java keystore:
<pre xsmall {>
$ openssl s_client \
   -connect www.mywebsite.com:443 \  
   -showcerts </dev/null 2>/dev/null | \
  openssl x509 \
    -outform PEM > infura-morden.pem
$ ($JAVA_HOME/Contents/Home/jre/bin/)keytool \
    -import -noprompt -trustcacerts \
    -alias www.mywebsite.com -f
</pre }>
<br/>
    See also: <a href="https://www.cs.utexas.edu/~shmat/shmat_ccs12.pdf">
         The Most Dangerous Code in the World: Validating SSL Certificates 
         in Non-Browser Software</a>
  </td>  
  <td col2 >
    <span xbig>View(-text) AND Verify (-verify) CSR:</span>
<pre {>
$ openssl req \
  -text -noout -verify -in ${DOMAIN}.csr
</pre }>
    <span xbig>Verify certificate was signed by a CA:</span>
<pre {>
$ openssl verify \
   -verbose -CAFile ca.crt ${DOMAIN}.crt
</pre }>

  </td>  
  <td col3 >
  </td>  
</tr }>

</body>
<!--
REF: http://www.alanflavell.org.uk/unicode/unidata25.html
─  ┐  ┠   ┰    ╀   ═   ╠   ╰     ┌─────┬─────┐
                                 │     │     │
━  ┑  ┡   ┱    ╁   ║   ╡   ╱     │     │     │
                                 ├─────┼─────┤
│  ┒  ┢   ┲    ╂   ╒   ╢   ╲     │     │     │
                                 │     │     │
┃  ┓  ┣   ┳    ╃   ╓   ╣   ╳     └─────┴─────┘
                                 ← ↑
┄  └  ┤   ┴    ╄   ╔   ╤   ╴     → ↓

┅  ┕  ┥   ┵    ╅   ╕   ╥   ╵     ┌─────────┐
                                 │         │
┆  ┖  ┦   ┶    ╆   ╖   ╦   ╶     │         │
                                 │         │
┇  ┗  ┧   ┷    ╇   ╗   ╧   ╷     │         │
                                 └─────────┘
┈  ┘  ┨   ┸    ╈   ╘   ╨   ╸ 

┉  ┙  ┩   ┹    ╉   ╙   ╩   ╹ 

┊  ┚  ┪   ┺    ╊   ╚   ╪   ╺ 

┋  ┛  ┫   ┻    ╋   ╛   ╫   ╻ 

┌  ├  ┬   ┼    ╌   ╜   ╬   ╼ 

┍  ┝  ┭   ┽    ╍   ╝   ╭   ╽ 

┎  ┞  ┮   ┾    ╎   ╞   ╮   ╾ 

┏  ┟  ┯   ┿    ╏   ╟   ╯   ╿ 

-->
<!--

-->

</html>
