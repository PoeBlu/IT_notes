<html>
<head>
   <meta charset="UTF-8">
   <title>NodeJS ILP-Connector map</title>
<style>
*[TODO]         { color:red; font-weight: bold; }
*[TODO]:before  { content: "TODO:"; }
*[xxxsmall]{ font-size:0.1rem; }
*[xxsmall] { font-size:0.3rem; }
*[xsmall]  { font-size:0.7rem; }
ul { margin-left: 1.0em; padding-left: 0rem; }
body      { font-family:sans-serif; padding: 0; margin: 0; }
#zoomDiv *[xxxsmall]{ font-size:1rem; }
#zoomDiv *[ xxsmall]{ font-size:1rem; }
#zoomDiv *[  xsmall]{ font-size:1rem; }
#zoomDiv  { 
   position:fixed; top:1%; left:1%; width:auto; height:auto;
   max-height: 98%; max-width: 98%; overflow: auto;
   background-color:#FFFFFF; color:#000; border-radius: 0.5rem; border: 4px solid black; font-size: 2rem;
   box-shadow: 5px 5px 30px black;
   padding: 0.5rem;
}
a            { text-decoration:none; font-family:monospace; padding:0.1em;}
a[href^="#"]:before /* mark internal anchor */ {  content: ">"; }
a[href^="#"]:after  /* mark internal anchor */ {  content: "<"; }
a:visited { color:blue; }
td { 
   font-size: 0.8rem;
   vertical-align: top;
   outline: 1px solid grey; 
}
td[col1]  {background-color:#FFFFFF; min-width:30%; max-width:30%; }
td[col2]  {background-color:#FFFFFF; min-width:30%; max-width:30%; }
td[col3]  {background-color:#FFFFFF; min-width:30%; max-width:30%; }
tr[header_delimit] > *{background-color:#AAAAAA; color:#FFFFFF; font-size:2em; ; text-align: center;}
</style>

<script>
var zoomDivDOM
function onZoomDivDoubleClick() { zoomDivDOM.innerHTML = ''; }
function onTDDoubleClick()      { zoomDivDOM.innerHTML = "('Esc' to close)<br/>" + this.innerHTML; }

function onPageLoaded() {
   /* Notes:
    * The name (and number) of columns 'topic', 'summa', 'col1', 'col2' is arbitrary.
    * Change at will. For example for development projects there could be a column for each 
    * software life-cycle similar to:  
    * topic -> summary -> documentation -> development -> testing/CI -> deployment -> QA
    * WARN: Don't forget to change the css too.
   */

  zoomDivDOM = document.getElementById('zoomDiv')
  zoomDivDOM.addEventListener('dblclick',onZoomDivDoubleClick, false)
  document.addEventListener('keyup',function(e) { if (e.code !== "Escape") return; onZoomDivDoubleClick(); })
  // Change default a.target to blank. Ussually this is bad practice 
  // but this is the exception to the rule
  var nodeList = document.querySelectorAll('a')
  for (idx in nodeList) { 
      if (!nodeList[idx].href) { continue; }
      if (nodeList[idx].href && !nodeList[idx].href.startsWith("http")) continue;
      nodeList[idx].target='_blank'; 
  }
  nodeList = document.querySelectorAll('td')
  for (idx in nodeList) { 
     if (!!! nodeList[idx].addEventListener) continue;
     nodeList[idx].addEventListener('dblclick',onTDDoubleClick, false)
  }
  setTimeout(onZoomDivDoubleClick, 3000);
}
</script>
</head>
<!--
ROW TEMPLATE:
<tr {>
  <td col1 >
     <pre>
     </pre>
  </td>  
  <td col2  >
     <pre>
     </pre>
  </td>
  <td col3 >
     <pre>
     </pre>
  </td>
</tr }>
-->
<body onLoad='onPageLoaded()'>
<div id='zoomDiv'>Hint: double-click on cell to zoom!!</div>
<br/> <br/> <br/> <br/>
<table>
<tr header_delimit {>
  <td colspan=3 >src/lib/config.js</td>
</tr>
<tr {>
  <td col1 >
ledgers this connector has accounts on used to auto-generate pairs.
     <pre>
export LEDGERS={ // us
   "http://usd-ledger.example": {
     "currency": "USD",
     "plugin": 'ilp-plugin-example',
     "options": {
       // plugin options ...
     }
   },
   "http://eur-ledger.example/some/path": {
     "currency": "EUR",
     "plugin": 'ilp-plugin-example',
     "options": {
       // plugin options ...
     }
   }
}
     </pre>
  </td>  
  <td col2  >
     <pre>
export ROUTES=[
    {
     "targetPrefix": "", // match any route
     "connectorLedger": "ilpdemo.red."
     "connectorAccount": "ilpdemo.red.connie"
    },
    {
      "targetPrefix": "usd.",
      "connectorLedger": "example.other."
      "connectorAccount": "example.other.connector"
     }]

export PAIRS=[
    ["USD@http://usd-ledger.example","EUR@http://eur-ledger.example"],
    ...
]
PEERS=peer1,peer2,peer3

ROUTE_BROADCAST_ENABLED # defaults to true

# For a 'core' node in an open network, set both to true.
# For a 'periphery' node in an open network,
#  set only the first one to true.
# For a node in a network where price competition between
# routes is not needed, set both to false.
BROADCAST_CURVES # defaults to true
STORE_CURVES # defaults to true

ROUTE_BROADCAST_INTERVAL # def. 30 * 1000 // milliseconds
ROUTE_CLEANUP_INTERVAL   # def. 1000 // milliseconds
ROUTE_EXPIRY             # def. 45 * 1000 // milliseconds
QUOTE_EXPIRY             # def. 45 * 1000 // milliseconds

AUTOLOAD_PEERS # defaults to false

# secret is used to generate destination transfer IDs
# that cannot be guessed and squatted on by others
export SECRET=<base64 32bytes string>
export UNWISE_USE_SAME_TRANSFER_ID=false


     </pre>
  </td>
  <td col3 >
     <pre {>

export DEBUG_REPLY_NOTIFICATIONS=true

const envPrefix = 'CONNECTOR'

export BACKEND='fixerio'
export MIN_MESSAGE_WINDOW=10 # in secs, defaults to 1
export MAX_HOLD_TIME=10 # in secs, defaults to 10
export DB_URI
export FX_SPREAD # defaults to 0.002 (0.2%)
export SLIPPAGE # defaults to 0.001 // 0.1%


# BACKEND_URI must be defined for backends that connect to an external
# component to retrieve the rate or amounts (it is therefore required
# when using the ilp-quote backend)
export BACKEND_URI=....

     </pre }>
  </td>
</tr }>

<tr header_delimit } {>
  <td colspan=3 >models</td>
</tr>
<tr {>
  <td col1 >
     src/models/pairs.js
     <pre>
function /*exported*/ getPairs (config, tradingPairsService) {
  const tradingPairs = tradingPairsService.toArray()
  return tradingPairs.map((pair) => {
    const currencies = pair.map(function (currencyLedgerString) {
      return currencyLedgerString.split('@')
    })
    return {
      source_asset: currencies[0][0],
      source_ledger: currencies[0][1],
      destination_asset: currencies[1][0],
      destination_ledger: currencies[1][1]
    }
  })
}
     </pre>
  </td>  
  <td col2  >
     src/models/payments.js
     <pre>
function * validateExpiry (sourceTransfer, destinationTransfer, config) 
           ^used by updateIncomingTransfer
module.exports = {
  function * updateIncomingTransfer (
             sourceTransfer,
             ledgers,
             config,
             routeBuilder)
  function * processExecutionFulfillment (
             transfer,
             fulfillment,
             ledgers,
             backend,
             config)
  function * rejectIncomingTransfer (
             sourceTransfer,
             _rejectionMessage,
             ledgers)
  function * rejectSourceTransfer (
             destinationTransfer,
             rejectionMessage,
             ledgers)
}
     </pre>
  </td>
  <td col3 >
     src/models/subscriptions.js
     <pre>
module.exports = {
  function * subscribePairs (ledgers, config, routeBuilder, backend) {
    ledgers.on('incoming_prepare' , (plugin, transfer) => ...)
    ledgers.on('incoming_transfer', (plugin, transfer) => ...)
    ledgers.on('outgoing_cancel'  , (plugin, transfer, rejectionMessage) => ...)
    ledgers.on('outgoing_reject'  , (plugin, transfer, rejectionMessage) => ...)
    ledgers.on('outgoing_fulfill' , (plugin, transfer, fulfillment) => ...)
  }
}
     </pre>
  </td>
</tr }>

<tr header_delimit } {>
  <td colspan=3 ><a href='https://github.com/interledger/rfcs/tree/master/0004-ledger-plugin-interface'>Plugin Interface</a></td>
<tr {>
  <td col1 >
     NodeJS Plugin Interface. See <a href='https://github.com/interledgerjs?utf8=%E2%9C%93&q=-plugin-&type=&language='>list of existing plugins</a>
     <pre>
class FiveBellsLedger extends EventEmitter2
  constructor (options) 

  async connect (options) 

  disconnect ()

  isConnected () 

  getInfo () 

  getAccount () 

  async getBalance ()

  registerRequestHandler (requestHandler) 

  deregisterRequestHandler () 

  sendRequest (message) 

  async sendTransfer (_transfer) 

  async fulfillCondition (transferId, fulfillment)

  getFulfillment (transferId) 

  rejectIncomingTransfer (transferId, rejectionMessage) 
     </pre>
  </td>  
  <td col2  >
     <pre>
     </pre>
  </td>
  <td col3 >
     <pre>
     </pre>
  </td>
</tr }>
</tr>

<tr header_delimit } {>
  <td colspan=3 >lib</td>
</tr>
<tr {>
  <td col1 >
     src/lib/ledgers.js
     <pre>
const PLUGIN_EVENTS = [
  'incoming_transfer', 'incoming_prepare', 
  'outgoing_fulfill' , 'outgoing_cancel'  , 'outgoing_reject'
]

class /*export*/ Ledgers extends EventEmitter
    // properties
    this.pluginList
    this.plugins // { prefix ⇒ LedgerPlugin }
    this.tables = routingTables
    this._config
    this._pairs // TradingPairs
    this._ledgers = new Map() // { prefix }
    this.requestHandler = co.wrap(this._requestHandler.bind(this))
    this._relayEvents = {}
    // methods--------------
    connect (options) // For each plugin in pluginList connect
    add (ledgerPrefix, creds, tradesTo, tradesFrom)
    getPlugin (ledgerPrefix) 
    getPlugins () { return this.pluginList }
    remove (ledgerPrefix)
    * _requestHandler (requestMessage)
    registerInternalRequestHandler (requestHandler)
    registerExternalRequestHandler (requestHandler) 
    addPlugin (prefix, plugin) 
    removePlugin (prefix) 

     </pre>
  </td>  
  <td col2  >
     src/lib/trading-pairs.js
     <pre>
class /*export*/ TradingPairs
  this._sources // 
      {  from1 /*USD@red.ilpdemo*/ :
            Set(
               to1_1 /*EUR@blue.ilpdemo.*/ ,
               to1_2 /*XRP@example.virtual. ...,) ,
         from2 :
            Set(
               to2_1 /*EUR@blue.ilpdemo.*/ ,
               to2_2 /*XRP@example.virtual. ...,) ,
      }
  this._pairsCache //
  // ----------------
  addPairs (pair_list /* pair =[from,to]*/)
  add (from, to)
  removeAll (id) /* remove any matching from/to */
  empty()
  toArray ()
     </pre>
  </td>
  <td col3 >
     <pre>
     </pre>
  </td>
</tr }>

<tr header_delimit } >
  <td colspan=3 ></td>
</tr>
</table>
</body>
<!--
REF: http://www.alanflavell.org.uk/unicode/unidata25.html
─  ┐  ┠   ┰    ╀   ═   ╠   ╰     ┌─────┬─────┐
                                 │     │     │
━  ┑  ┡   ┱    ╁   ║   ╡   ╱     │     │     │
                                 ├─────┼─────┤
│  ┒  ┢   ┲    ╂   ╒   ╢   ╲     │     │     │
                                 │     │     │
┃  ┓  ┣   ┳    ╃   ╓   ╣   ╳     └─────┴─────┘
                                 ← ↑
┄  └  ┤   ┴    ╄   ╔   ╤   ╴     → ↓

┅  ┕  ┥   ┵    ╅   ╕   ╥   ╵     ┌─────────┐
                                 │         │
┆  ┖  ┦   ┶    ╆   ╖   ╦   ╶     │         │
                                 │         │
┇  ┗  ┧   ┷    ╇   ╗   ╧   ╷     │         │
                                 └─────────┘
┈  ┘  ┨   ┸    ╈   ╘   ╨   ╸ 

┉  ┙  ┩   ┹    ╉   ╙   ╩   ╹ 

┊  ┚  ┪   ┺    ╊   ╚   ╪   ╺ 

┋  ┛  ┫   ┻    ╋   ╛   ╫   ╻ 

┌  ├  ┬   ┼    ╌   ╜   ╬   ╼ 

┍  ┝  ┭   ┽    ╍   ╝   ╭   ╽ 

┎  ┞  ┮   ┾    ╎   ╞   ╮   ╾ 

┏  ┟  ┯   ┿    ╏   ╟   ╯   ╿ 
-->

<!--
config.js:
https://github.com/interledgerjs/ilp-connector/blob/master/src/lib/config.js

-->
</html>
 

