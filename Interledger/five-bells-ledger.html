<!DOCTYPE html>
<html>
<!--
 Q:Note what the attribute { and } do:
 A:Those attributes are ignored by the browser but are helpful to fold/unfold text in some
   editors (Vim, Emacs,...)
-->
<!--
ROW TEMPLATE
<tr {>
  <td topic         >XXXX</td>
  <td summary       >(summary explaining the topic)</td>
  <td documentation >(Links to docs) </td>
  <td development   >(Github link and anyother development resource)</td>
</tr }>
-->

<head>
<script>
function onPageLoaded() {
  // Change default a.target to blank. Ussually this is bad practice 
  // but this is the exception to the rule
  var nodeList = document.querySelectorAll('a')
  for (idx in nodeList) { nodeList[idx].target='_blank'; }
}
</script>
<style>
body      { font-family:sans-serif; }
a         { text-decoration:none; font-family:monospace; font-size:1.5em; padding:0.1em;}
a:visited { color:blue; }
td { 
   vertical-align: top;
   outline: 1px solid grey; 
}
td[topic]         ,th[topic]         {background-color:#FFFFFF;}
td[summary]       ,th[summary]       {background-color:#FAFAFA; min-width:50%; max-width:50%; }
td[documentation] ,th[documentation] {background-color:#FFFFFF;}
td[development]   ,th[development]   {background-color:#FAFAFA;}
td[testing/CI]    ,th[testing/CI]    {background-color:#FFFFFF;}
td[deployment]    ,th[deployment]    {background-color:#FAFAFA;}
th[header_delimit]{background-color:#000000; color:#FFFFFF; font-size:2em;}
</style>
</head>
<body onLoad='onPageLoaded()'>
<table style='width:100%'{>
  <thead {>
  <tr {>
     <th  topic        ><div><a href="./interledger_map.html">(CLICK TO CLONE)</a></th>
     <th  summary      ><div>summary</th>
     <th  documentation>&nbsp;documentation</th>
     <th  development  >development</th>
  </tr }>
  </thead }>
<tbody>
<tr {>
  <th colspan=6 header_delimit>five-bells-ledger</th>
</tr }>
<tr {>
  <td topic         >Notification broadcaster</td>
  <td summary       >five-bells-ledger app creates a singleton NotificationBroadcaster in charge of passing events/messages between components (app.js -> this.notificationBroadcaster = modules.notificationBroadcaster)</td>
  <td documentation >(Links to docs) </td>
  <td development   >Sending new notifications:
<pre>
(transferExpireMonitor.js)
_this.notificationBroadcaster.sendNotifcations(transfer, transaction)

Sending messages:
(messages.js)
const messageDelivered = yield notificationBroadcaster.sendMessage(
  recipientName, message})
</pre>
  </td>
</tr }>
<tr {>
  <td topic         >Subscriptions</td>
  <td summary       >
                     Other components (rpcHandler at this moment) can subscribe to notification by using <br/>
                     <pre>NotificationBroadcast.addNotificationListener(accountName, eventType, listener)</pre> 
                     and unsubscribe with:<br/>
                     <pre>NotificationBroadcast.removeNotificationListener(accountName, eventType, listener)</pre>
  </td>
  <td documentation >(Links to docs) </td>
  <td development   >(Github link and anyother development resource)</td>
</tr }>
<tr {>
  <td topic         >rpcHandler (TODO)</td>
  <td summary       >listen for internal messages from NotificationBroadcast and forward them to associated ws client
                     Each RpcHandler instance <-> params, websocket, requestingUser<br/>
                     <pre>
      params = uriManager, validator, notificationBoradcaster
      constructor (params, websocket, requestingUser) {
        ...
        websocket.on('message', this.handleMessage.bind(this))
        websocket.on('close', this._onClose.bind(this))
        ...
      }
      _send (resMessage) { this.websocket.send(JSON.stringify(resMessage), }) }
                     </pre>
  </td>
  <td documentation >(Links to docs) </td>
  <td development   >(Github link and anyother development resource)</td>
</tr }>
<tr {>
  <td topic         >handling received messaged</td>
  <td summary       >Received WS Client (subscription) messages are bined to handleMessage: 
    <pre>
    websocket.on('message' /*WS Client Subscription message*/,
      this.handleMessage.bind(this))
    WS Client Message -> 
      handleMessage (message) -> 
        subcribeAccount/allAccounts ->
          notificationBroadcaster.addNotificationListener(...)
    </pre>
  </td>
  <td documentation >(Links to docs) </td>
  <td development   >(Github link and anyother development resource)</td>
</tr }>
<tr {>
  <td topic         >XXXX</td>
  <td summary       >five-bells ledger internal account events* are binded to notification Listener sendNotification:
    <pre>
    subscribeAccount
      this.notificationBroadcaster.addNotificationListener(accountName, eventType, this.sendNotification)
      this.notificationBroadcaster.addNotificationListener('*', eventType, this.sendNotification)
    </pre>
</td>
  <td documentation >(Links to docs) </td>
  <td development   >(Github link and anyother development resource)</td>
</tr }>
<tr {>
  <td topic         >XXXX</td>
  <td summary       >
    </pre>
          ws client -> koa: GET /websocket
        koa --> (src/controllers/)accounts.js:* subscribeTransfers() 
        * subscribeTransfers() ->  makeRpcHandler(this.webSocket, this.req.user)
        koa -> ws client: 101 Switching Protocols"</td>
    </pre>
  <td documentation >(Links to docs) </td>
  <td development   >(Github link and anyother development resource)</td>
</tr }>


<tr {>
  <td topic         >XXXX</td>
  <td summary       >SUBSCRIBE ACCOUNT 
    <pre>
    WS: REQUEST                                      | WS RESPONSE OK
    { ""jsonrpc"": ""2.0"", ""id"": 1,               | { ""jsonrpc"": ""2.0"", ""id"": 1, ""result"": 1 }
      ""method"": ""subscribe_account"", *1          | 
      ""params"": {                                  | WS RESPONSE ERROR
        ""eventType"": ""*"",                        | { ""jsonrpc"": ""2.0"", ""id"": 1,
        ""accounts"": [""http://.../accounts/alice""]|   ""error"": 
      }                                              |     { ""code"": 4000, ""message"": ""RpcError"",
    }                                                |       ""data"": ""Invalid id"" }
                                                     | }
    *1: or ""subscribe_all_accounts""
    </pre>
  </td>
  <td documentation >(Links to docs) </td>
  <td development   >(Github link and anyother development resource)</td>
</tr }>


<tr {>
  <td topic         >XXXX</td>
  <td summary       >
    <pre>
    Push transfer notification                                                         | Push message notification
    { ""jsonrpc"": ""2.0"", ""id"": null,                                              | { ""jsonrpc"": ""2.0"", ""id"": null, ""method"": ""notify"",
      ""method"": ""notify"",                                                          |   ""params"": { ""event"": ""message.send"",
      ""params"": {                                                                    |     ""resource"":{
        ""event"": ""transfer.update"",                                                |       ""ledger"": ""http://usd-localhost"",
        ""resource"":{                                                                 |       ""from"": ""http://usd-localhost/accounts/alice"",
          ""debits"":[ { ""account"":""http://usd-ledger/accounts/alice"",             |       ""to"": ""http://usd-localhost/accounts/bob"",
              ""amount"":""0.01"", ""authorized"":true } ],                            |       ""data"": { ""foo"": ""bar"" }
          ""credits"":[ { ""account"":""http://usd-ledger/accounts/bob"",              |     }
              ""amount"":""0.01"" } ],                                                 |   }
          ""id"":""http://..../4f122511-989d-101e-f938-573993b75e22"",                 | }
          ""ledger"":""http://usd-localhost"",                                         |
          ""state"":""executed"",                                                      |
          ""timeline"":{ ""proposed_at"":., ""prepared_at"":., ""executed_at"":...  }  |
        }
      }
    }
    </pre>
</td>
  <td documentation >(Links to docs) </td>
  <td development   >(Github link and anyother development resource)</td>
</tr }>



</tbody>
</table }>
</div>
</body>
<!-- TODO:(0)
= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 

= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
"
-->
</html>
